<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>נקודות לירי v4.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #1a1a1a;
            --primary: #9d4edd;
            --primary-glow: rgba(157, 78, 221, 0.4);
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.4);
            --danger: #ff4d4d;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --trend-up: #00ff88;
            --trend-down: #ff4d4d;
            --trend-equal: #9d4edd;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Header & Nav --- */
        header {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
            width: 100%;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(to right, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .motivation-line {
            font-size: 1rem;
            color: var(--text-muted);
            margin-top: 5px;
            font-weight: 300;
        }

        .nav-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
            width: 90%;
            max-width: 500px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            border-radius: 12px;
            color: var(--text-main);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--card-bg);
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* --- Sections --- */
        .section {
            display: none; /* מוסתר כברירת מחדל */
            width: min(500px, 92%);
            flex-direction: column;
            gap: 15px;
            padding-bottom: 100px;
            animation: fadeIn 0.4s ease-in-out;
        }

        .section.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Scoreboard Styles --- */
        .friend {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 20px; border-radius: 16px;
            border: 1px solid #333; transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }
        .friend:hover { transform: translateY(-2px); border-color: #444; }
        .friend.gold-border { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
        .friend.silver-border { border-color: var(--silver); }

        .name-group { display: flex; align-items: center; gap: 10px; }
        .name { font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
        
        .value-badge { font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; font-weight: bold; color: #000; margin-right: 8px; }
        .badge-gold { background: var(--gold); }
        .badge-silver { background: var(--silver); }

        /* Admin Controls */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        body.is-admin .admin-block { display: block !important; }

        .controls {
            display: flex; align-items: center; gap: 12px;
            background: #000; padding: 5px 10px; border-radius: 12px; border: 1px solid #333;
        }
        .arrow { cursor: pointer; color: var(--primary); font-size: 1.2rem; user-select: none; padding: 0 5px; }
        .arrow:hover { color: var(--accent); transform: scale(1.2); }
        .number { font-size: 1.3rem; font-weight: bold; color: var(--accent); min-width: 35px; text-align: center; }
        body.is-admin .number, body.is-admin .name { cursor: pointer; text-decoration: underline dotted #555; }
        .delete-btn { background: none; border: none; color: #555; font-size: 1.1rem; cursor: pointer; margin-left: 5px; }
        .delete-btn:hover { color: var(--danger); }

        /* --- Analytics / Graphs --- */
        .chart-container {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;}
        .chart-title { font-weight: bold; color: var(--primary); }
        
        select, .time-selector {
            background: #000; color: white; border: 1px solid #444; padding: 5px 10px; border-radius: 8px; font-family: inherit; outline: none;
        }
        
        /* Multi-select styling mock */
        .multi-select-container {
            max-height: 100px; overflow-y: auto; background: #000; border: 1px solid #444; padding: 5px; border-radius: 8px; display: none;
            position: absolute; z-index: 10; width: 200px;
        }
        .multi-select-trigger { cursor: pointer; background: #000; border: 1px solid #444; padding: 5px 10px; border-radius: 8px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem;}
        
        .time-range-bar { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; flex-wrap: wrap; }
        .range-btn {
            background: transparent; border: 1px solid #333; color: #888; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
        }
        .range-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Updates Feed --- */
        .update-card {
            background: var(--card-bg); border-radius: 16px; padding: 15px; border: 1px solid #333; margin-bottom: 15px;
        }
        .update-meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .update-title { font-size: 1.1rem; font-weight: bold; color: var(--accent); margin-bottom: 5px; }
        .update-content { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
        
        /* Forms */
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; background: var(--card-bg); padding: 15px; border-radius: 16px; border: 1px solid #333; }
        input, textarea { background: #000; border: 1px solid #333; padding: 10px; border-radius: 8px; color: white; font-family: inherit; outline: none; width: 100%; box-sizing: border-box;}
        input:focus, textarea:focus { border-color: var(--primary); }
        .action-btn { background: linear-gradient(135deg, var(--primary), #7b2cbf); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px;}
        
        .rich-text-controls { display: flex; gap: 5px; margin-bottom: 5px; }
        .rt-btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .rt-btn:hover { background: var(--primary); }

        #adminHeader { display: none; color: var(--primary); text-align: center; margin-bottom: 10px; font-size: 0.9rem; letter-spacing: 1px; }
        body.is-admin #adminHeader { display: block; }

        /* Loader */
        #loader { margin-top: 20px; color: var(--text-muted); }
    </style>
</head>
<body>

    <header>
        <h1>נקודות לירי</h1>
        <div class="motivation-line">כל נקודה נחשבת, אבל המקום הראשון נחשב יותר</div>
        <div id="adminHeader">-- ADMIN MODE --</div>
    </header>

    <div class="nav-container">
        <div class="nav-btn active" onclick="showSection('homeSection', this)">הבית</div>
        <div class="nav-btn" onclick="showSection('scoreboardSection', this)">לוח תוצאות</div>
        <div class="nav-btn" onclick="showSection('analyticsSection', this)">מדדים</div>
    </div>

    <div id="homeSection" class="section active">
        <h2 style="text-align:center; margin:0; color:var(--text-muted); font-weight:300;">עדכונים אחרונים</h2>
        
        <div class="input-group admin-block" style="display:none;">
            <h3 style="margin:0; color:var(--primary);">פרסם עדכון חדש</h3>
            <input id="postAuthor" list="authorsList" placeholder="שם המפרסם..." />
            <datalist id="authorsList"></datalist>
            <input id="postTitle" placeholder="כותרת הפוסט" />
            
            <div class="rich-text-controls">
                <button class="rt-btn" onclick="formatText('b')">B</button>
                <button class="rt-btn" onclick="formatText('i')">I</button>
                <button class="rt-btn" onclick="formatText('u')">U</button>
                <button class="rt-btn" onclick="addLink()">Link</button>
            </div>
            <textarea id="postContent" rows="4" placeholder="תוכן העדכון (ניתן להשתמש ב-HTML)"></textarea>
            <button class="action-btn" onclick="publishUpdate()">פרסם לכולם</button>
        </div>

        <div id="updatesFeed">
            <div id="loader">טוען עדכונים...</div>
        </div>
    </div>

    <div id="scoreboardSection" class="section">
        <div id="scoreboardContainer" style="display:flex; flex-direction:column; gap:15px;"></div>

        <div class="input-group admin-block" style="display:none; margin-top:30px;">
            <h3 style="margin:0; color:var(--primary);">הוסף חבר חדש</h3>
            <input id="newFriendName" type="text" placeholder="שם החבר/ה" autocomplete="off" />
            <input id="newFriendPoints" type="number" placeholder="ניקוד התחלתי" />
            <button class="action-btn" onclick="addNewFriend()">הוסף לרשימה</button>
        </div>
    </div>

    <div id="analyticsSection" class="section">
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">השוואת נקודות</div>
                <div style="position:relative;">
                    <div class="multi-select-trigger" onclick="toggleMultiSelect()">
                        בחר שמות ▼
                    </div>
                    <div id="multiSelectOptions" class="multi-select-container">
                        </div>
                </div>
            </div>
            <div class="time-range-bar" id="rangeBar1">
                <button class="range-btn" onclick="setRange(1, '1d')">יום 1</button>
                <button class="range-btn" onclick="setRange(1, '5d')">5 ימים</button>
                <button class="range-btn" onclick="setRange(1, '1mo')">חודש</button>
                <button class="range-btn" onclick="setRange(1, '6mo')">6 חודשים</button>
                <button class="range-btn active" onclick="setRange(1, 'max')">משחר ההיסטוריה</button>
            </div>
            <canvas id="comparisonChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">נקודות לפי שם</div>
                <select id="individualSelect" onchange="renderIndividualGraph()">
                    </select>
            </div>
            <div class="time-range-bar" id="rangeBar2">
                <button class="range-btn" onclick="setRange(2, '1d')">יום 1</button>
                <button class="range-btn" onclick="setRange(2, '5d')">5 ימים</button>
                <button class="range-btn" onclick="setRange(2, '1mo')">חודש</button>
                <button class="range-btn" onclick="setRange(2, '6mo')">6 חודשים</button>
                <button class="range-btn active" onclick="setRange(2, 'max')">משחר ההיסטוריה</button>
            </div>
            <canvas id="individualChart"></canvas>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, serverTimestamp, addDoc, query, orderBy, getDocs, writeBatch, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ================= CONFIGURATION =================
        const firebaseConfig = {
            apiKey: "AIzaSyC46vuypuxi1RQjsupuv3RxA7sVRfZprBI",
            authDomain: "liri-points-database.firebaseapp.com",
            projectId: "liri-points-database",
            storageBucket: "liri-points-database.firebasestorage.app",
            messagingSenderId: "448210240092",
            appId: "1:448210240092:web:faa216ff11c887f3de1c99"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State Management
        window.currentUser = null;
        let friendsData = [];
        let historyData = [];
        let chartInstances = { 1: null, 2: null };
        let activeRanges = { 1: 'max', 2: 'max' };
        let selectedComparison = [];

        // 1. Authentication & Init
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') {
            const email = "admin@burkason.com";
            const password = prompt("הכנס סיסמת מנהל:");
            if (password) {
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => window.history.replaceState({}, document.title, "/"))
                    .catch(() => alert("סיסמה שגויה"));
            }
        }

        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            document.body.classList.toggle("is-admin", !!user);
            if (friendsData.length > 0) renderAll();
        });

        // 2. Real-time Listeners
        // האזנה לחברים (עבור לוח תוצאות ורשימות)
        onSnapshot(collection(db, "friends"), (snapshot) => {
            friendsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderScoreboard();
            updateDropdowns();
            if(document.getElementById("analyticsSection").classList.contains("active")) {
                loadGraphData(); // רענון גרפים אם יש שינוי
            }
        });

        // האזנה לעדכונים
        const qUpdates = query(collection(db, "updates"), orderBy("timestamp", "desc"));
        onSnapshot(qUpdates, (snapshot) => {
            const feed = document.getElementById("updatesFeed");
            feed.innerHTML = "";
            const authors = new Set();

            if (snapshot.empty) {
                feed.innerHTML = `<div style="text-align:center; color:#555; margin-top:20px;">אין עדכונים עדיין.</div>`;
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                if(data.author) authors.add(data.author);
                
                const dateStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('he-IL') : "";
                
                const el = document.createElement("div");
                el.className = "update-card";
                el.innerHTML = `
                    <div class="update-meta">
                        <span>מאת: ${data.author || "מערכת"}</span>
                        <span>${dateStr}</span>
                    </div>
                    <div class="update-title">${data.title}</div>
                    <div class="update-content">${data.content}</div>
                    <button class="delete-btn admin-only" onclick="deleteUpdate('${doc.id}')" style="margin-top:10px; font-size:0.8rem;">מחק פוסט</button>
                `;
                feed.appendChild(el);
            });

            // עדכון רשימת המחברים להשלמה אוטומטית
            const datalist = document.getElementById("authorsList");
            datalist.innerHTML = "";
            authors.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a;
                datalist.appendChild(opt);
            });
        });

        // 3. Navigation Logic
        window.showSection = (id, btn) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');

            if (id === 'analyticsSection') {
                loadGraphData();
            }
        };

        // 4. Scoreboard Functions
        function renderScoreboard() {
            const container = document.getElementById("scoreboardContainer");
            container.innerHTML = "";
            
            // Sort: Descending points
            const sorted = [...friendsData].sort((a, b) => b.points - a.points);

            sorted.forEach((friend, index) => {
                const el = document.createElement("div");
                el.className = "friend";
                
                let badge = "";
                if (index === 0 && sorted.length > 0) {
                    badge = `<span class="value-badge badge-gold">10 ₪</span>`;
                    el.classList.add("gold-border");
                } else if (index === 1 && sorted.length > 1) {
                    badge = `<span class="value-badge badge-silver">1 לירה</span>`;
                    el.classList.add("silver-border");
                }

                el.innerHTML = `
                    <div class="name-group">
                        <button class="delete-btn admin-only" onclick="deleteFriend('${friend.id}')">✕</button>
                        <div class="name" id="name-${index}">${friend.id}</div>
                        ${badge}
                    </div>
                    <div class="controls">
                        <div class="arrow admin-only" onclick="updatePoints('${friend.id}', -1)">▼</div>
                        <div class="number" onclick="manualEdit('${friend.id}')">${friend.points}</div>
                        <div class="arrow admin-only" onclick="updatePoints('${friend.id}', 1)">▲</div>
                    </div>
                `;
                container.appendChild(el);

                // Event listener for renaming (only works if admin check inside func passes)
                document.getElementById(`name-${index}`).onclick = () => renameFriend(friend.id, friend.points);
            });
        }

        // 5. Admin Actions (Scoreboard)
        window.updatePoints = async (name, delta) => {
            const f = friendsData.find(x => x.id === name);
            if(!f) return;
            const newPts = f.points + delta;
            await updateDoc(doc(db, "friends", name), { points: newPts, lastUpdate: serverTimestamp() });
            recordHistory(name, newPts);
        };

        window.manualEdit = async (name) => {
            if (!window.currentUser) return;
            const f = friendsData.find(x => x.id === name);
            const val = prompt(`שנה ניקוד ל-${name}:`, f.points);
            if (val && !isNaN(val)) {
                await updateDoc(doc(db, "friends", name), { points: Number(val), lastUpdate: serverTimestamp() });
                recordHistory(name, Number(val));
            }
        };

        window.addNewFriend = async () => {
            const n = document.getElementById("newFriendName").value.trim();
            const p = Number(document.getElementById("newFriendPoints").value) || 0;
            if (!n) return;
            if (friendsData.find(f => f.id === n)) return alert("השם קיים כבר");
            
            await setDoc(doc(db, "friends", n), { points: p, lastUpdate: serverTimestamp() });
            recordHistory(n, p);
            document.getElementById("newFriendName").value = "";
            document.getElementById("newFriendPoints").value = "";
        };

        window.deleteFriend = async (name) => {
            if (confirm(`למחוק את ${name}? (ההיסטוריה תישמר במערכת אך לא תוצג)`)) {
                await deleteDoc(doc(db, "friends", name));
            }
        };

        // --- RENAME LOGIC (COMPLEX) ---
        window.renameFriend = async (oldName, currentPoints) => {
            if (!window.currentUser) return;
            const newName = prompt(`שנה שם מ-${oldName} ל:`, oldName);
            if (!newName || newName === oldName || newName.trim() === "") return;
            if (friendsData.find(f => f.id === newName)) return alert("השם החדש כבר תפוס!");

            if (!confirm(`פעולה זו תעדכן את כל היסטוריית הגרפים של ${oldName} ל-${newName}. להמשיך?`)) return;

            // 1. Create new friend doc
            await setDoc(doc(db, "friends", newName), { points: currentPoints, lastUpdate: serverTimestamp() });
            
            // 2. Delete old friend doc
            await deleteDoc(doc(db, "friends", oldName));

            // 3. Update History (Batch Operation)
            // Note: Batch limit is 500. For large apps, use cloud functions. Here we do simplified client batch.
            const historyRef = collection(db, "history");
            const q = query(historyRef, where("name", "==", oldName));
            const querySnapshot = await getDocs(q);
            
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.update(doc.ref, { name: newName });
            });
            
            try {
                await batch.commit();
                alert("השם וההיסטוריה עודכנו בהצלחה!");
            } catch (e) {
                console.error(e);
                alert("השם שונה, אך הייתה שגיאה בעדכון ההיסטוריה.");
            }
        };

        async function recordHistory(name, pts) {
            // Calculate Total
            const total = friendsData.reduce((s, f) => s + (f.id === name ? pts : f.points), 0);
            await addDoc(collection(db, "history"), { 
                name, points: pts, totalPoints: total, timestamp: serverTimestamp() 
            });
        }

        // 6. Updates System
        window.publishUpdate = async () => {
            const author = document.getElementById("postAuthor").value;
            const title = document.getElementById("postTitle").value;
            const content = document.getElementById("postContent").value;
            
            if(!title || !content) return alert("חובה למלא כותרת ותוכן");

            await addDoc(collection(db, "updates"), {
                author, title, content, timestamp: serverTimestamp()
            });

            document.getElementById("postTitle").value = "";
            document.getElementById("postContent").value = "";
        };

        window.deleteUpdate = async (id) => {
            if(confirm("למחוק את הפוסט?")) await deleteDoc(doc(db, "updates", id));
        };

        // Rich Text Helpers
        window.formatText = (tag) => {
            const area = document.getElementById("postContent");
            const start = area.selectionStart;
            const end = area.selectionEnd;
            const text = area.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);
            const selection = text.substring(start, end);
            
            if(tag === 'link') {
                // implemented in addLink
            } else {
                area.value = before + `<${tag}>` + selection + `</${tag}>` + after;
            }
        };

        window.addLink = () => {
            const area = document.getElementById("postContent");
            const url = prompt("הכנס כתובת URL:");
            if(url) {
                area.value += `<a href="${url}" target="_blank">קישור</a>`;
            }
        };

        // 7. ANALYTICS & CHARTS
        
        function updateDropdowns() {
            // Comparison Multi-Select
            const multiContainer = document.getElementById("multiSelectOptions");
            if (!multiContainer.children.length) { // Only populate if empty to not reset selection
                 // But wait, if new friend added? better recreate logic:
                 // We will retain selection if possible
                 const currentSelection = Array.from(multiContainer.querySelectorAll('input:checked')).map(i => i.value);
                 multiContainer.innerHTML = "";
                 
                 friendsData.forEach(f => {
                     const div = document.createElement("div");
                     div.className = "multi-select-option";
                     div.style.padding = "5px";
                     div.innerHTML = `
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" value="${f.id}" onchange="updateComparisonSelection()" ${currentSelection.includes(f.id) ? 'checked' : ''}>
                            ${f.id}
                        </label>
                     `;
                     multiContainer.appendChild(div);
                 });
            }

            // Individual Select
            const indSelect = document.getElementById("individualSelect");
            const currentVal = indSelect.value;
            indSelect.innerHTML = `<option value="total">סכום כולל (כולם)</option>`;
            friendsData.forEach(f => {
                const opt = document.createElement("option");
                opt.value = f.id;
                opt.textContent = f.id;
                indSelect.appendChild(opt);
            });
            if(currentVal) indSelect.value = currentVal;
        }

        window.toggleMultiSelect = () => {
            const el = document.getElementById("multiSelectOptions");
            el.style.display = el.style.display === "block" ? "none" : "block";
        };

        window.updateComparisonSelection = () => {
            const checkboxes = document.querySelectorAll('#multiSelectOptions input:checked');
            selectedComparison = Array.from(checkboxes).map(c => c.value);
            renderComparisonGraph();
        };

        // --- Loading History Data ---
        async function loadGraphData() {
            // Fetch ALL history ordered by time. 
            // In a huge app, we would query with limits, but for this scale, fetch all is fine for smooth graphs.
            const q = query(collection(db, "history"), orderBy("timestamp", "asc"));
            const snapshot = await getDocs(q);
            
            historyData = snapshot.docs.map(doc => {
                const d = doc.data();
                return {
                    name: d.name,
                    points: d.points,
                    total: d.totalPoints,
                    date: d.timestamp ? d.timestamp.toDate() : new Date(),
                    t: d.timestamp ? d.timestamp.toMillis() : Date.now()
                };
            });

            renderComparisonGraph();
            renderIndividualGraph();
        }

        // --- Chart Helper Functions ---
        function filterByTime(data, rangeCode) {
            if (rangeCode === 'max') return data;
            const now = Date.now();
            let duration = 0;
            if (rangeCode === '1d') duration = 24 * 60 * 60 * 1000;
            if (rangeCode === '5d') duration = 5 * 24 * 60 * 60 * 1000;
            if (rangeCode === '1mo') duration = 30 * 24 * 60 * 60 * 1000;
            if (rangeCode === '6mo') duration = 6 * 30 * 24 * 60 * 60 * 1000;
            
            return data.filter(item => (now - item.t) <= duration);
        }

        function getChartConfig(datasets, isTimeScale) {
            return {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    elements: {
                        point: { radius: 0, hoverRadius: 6 }, // Show point only on hover
                        line: { tension: 0.4, borderJoinStyle: 'round' } // Smooth curves (interpolation)
                    },
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: '#00ff88',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            callbacks: {
                                title: (context) => {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleString('he-IL', { 
                                        day: 'numeric', month: 'short', year: 'numeric', 
                                        hour: '2-digit', minute:'2-digit', 
                                        timeZone: 'Asia/Jerusalem' 
                                    }) + " GMT+2";
                                },
                                label: (context) => {
                                    return ` ${context.dataset.label}: ${context.parsed.y} נק"ל`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'd/M' } },
                            grid: { color: '#333' },
                            ticks: { color: '#aaa' }
                        },
                        y: {
                            grid: { color: '#333' },
                            ticks: { color: '#aaa' }
                        }
                    }
                }
            };
        }

        // --- GRAPH 1: Comparison ---
        window.renderComparisonGraph = () => {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (chartInstances[1]) chartInstances[1].destroy();

            // Filter data by range
            const filteredHistory = filterByTime(historyData, activeRanges[1]);

            // Create datasets for selected users
            const datasets = [];
            const colors = ['#ff0055', '#00ff88', '#00ccff', '#ffaa00', '#9d4edd', '#ffffff', '#ff00ff']; // Palette
            
            selectedComparison.forEach((name, idx) => {
                // Get data points for this user
                // Note: We need to handle the "stepping" logic visually? 
                // Chart.js does lines between points. If a user didn't change for a month, we need their last known point at the start of the graph?
                // For simplicity in this version, we plot recorded changes. 
                
                const userPoints = filteredHistory.filter(h => h.name === name)
                                                  .map(h => ({ x: h.date, y: h.points }));
                
                // Add current state point to make graph reach "now"
                const current = friendsData.find(f => f.id === name);
                if(current) {
                    userPoints.push({ x: new Date(), y: current.points });
                }

                datasets.push({
                    label: name,
                    data: userPoints,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length],
                    borderWidth: 2,
                    fill: false
                });
            });

            chartInstances[1] = new Chart(ctx, getChartConfig(datasets));
        };

        // --- GRAPH 2: Individual / Total ---
        window.renderIndividualGraph = () => {
            const ctx = document.getElementById('individualChart').getContext('2d');
            if (chartInstances[2]) chartInstances[2].destroy();
            
            const selection = document.getElementById("individualSelect").value;
            const filteredHistory = filterByTime(historyData, activeRanges[2]);
            let dataPoints = [];
            let label = "";

            if (selection === 'total') {
                label = "סכום כולל";
                dataPoints = filteredHistory.map(h => ({ x: h.date, y: h.total }));
                // Add current total
                const grandTotal = friendsData.reduce((s,f) => s + f.points, 0);
                dataPoints.push({ x: new Date(), y: grandTotal });
            } else {
                label = selection;
                dataPoints = filteredHistory.filter(h => h.name === selection).map(h => ({ x: h.date, y: h.points }));
                const current = friendsData.find(f => f.id === selection);
                if(current) dataPoints.push({ x: new Date(), y: current.points });
            }

            // Determine Trend Color (Green/Red)
            let color = '#9d4edd'; // Default
            if (dataPoints.length > 1) {
                const start = dataPoints[0].y;
                const end = dataPoints[dataPoints.length - 1].y;
                if (end > start) color = '#00ff88'; // Green
                else if (end < start) color = '#ff4d4d'; // Red
            }

            const dataset = {
                label: label,
                data: dataPoints,
                borderColor: color,
                backgroundColor: color, // For point hover
                borderWidth: 2,
                fill: {
                    target: 'origin',
                    above: color + '10', // Very transparent fill
                    below: color + '10'
                }
            };

            chartInstances[2] = new Chart(ctx, getChartConfig([dataset]));
        };

        // Range Buttons Logic
        window.setRange = (graphId, range) => {
            activeRanges[graphId] = range;
            
            // Update UI buttons
            const bar = document.getElementById(`rangeBar${graphId}`);
            bar.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            // Rerender
            if (graphId === 1) renderComparisonGraph();
            else renderIndividualGraph();
        };

        // Render everything initial
        function renderAll() {
            renderScoreboard();
            updateDropdowns();
        }

    </script>
</body>
</html>
